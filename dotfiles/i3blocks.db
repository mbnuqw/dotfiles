#!/usr/bin/env python3

import re
import math
import sys
import os
from subprocess import run, PIPE

btn = os.environ["BLOCK_BUTTON"]
# BLOCK_BUTTON:
# 1 - left
# 3 - right
# 2 - middle
# 5 - scroll down
# 4 - scroll up

# Middle - Play/Pause
if btn == "2":
  run(["deadbeef", "--play-pause"], stdout=PIPE)
# Left - prev song
elif btn == "1":
  run(["deadbeef", "--prev"], stdout=PIPE)
# Right - next song
elif btn == "3":
  run(["deadbeef", "--next"], stdout=PIPE)

procs = run(["ps", "axw"], stdout=PIPE).stdout.decode("utf-8")

fg_color = "#a8a8a8"
play_color = "#cecece"
pause_color = "#969696"

# fg_color = "#323232"
# play_color = "#323232"
# pause_color = "#969696"

if re.search("deadbeef", procs) is None:
  print("")
else:
  song_raw = run(["deadbeef", "--nowplaying-tf", "%artist% - %title%"], stdout=PIPE).stdout
  song = song_raw.decode("utf-8")
  # song = song.replace("&", "&amp;")
  song_len = len(song)

  sec_raw = run(["deadbeef", "--nowplaying-tf", "%playback_time_seconds%"], stdout=PIPE).stdout
  sec = float(sec_raw.decode("utf-8"))

  lensec_raw = run(["deadbeef", "--nowplaying-tf", "%length_seconds%"], stdout=PIPE).stdout
  lensec = int(lensec_raw.decode("utf-8"))

  isplaying_raw = run(["deadbeef", "--nowplaying-tf", "%isplaying%"], stdout=PIPE).stdout
  isplaying = isplaying_raw.decode("utf-8")

  if isplaying:
    prog_color = play_color
  else:
    prog_color = pause_color

  progress = math.ceil(song_len / lensec * sec)
  reprogress = song_len - progress
  start = song[:progress].replace("&", "&amp;")
  end = "" if reprogress <= 0 else song[-reprogress:].replace("&", "&amp;")

  print("<span underline=\"single\" underline_color=\"" + prog_color + "\" foreground=\"" + prog_color + "\">" + start + "</span><span foreground=\"" + prog_color + "\">" + end + "</span>")
